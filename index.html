<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Cidadão - Santa Cruz do Capibaribe</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS (para o mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js (para os gráficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome (Ícones) - ATUALIZADO -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Fonte Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        #mapa { 
            height: 500px; 
            border-radius: 0.5rem; 
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Ícones personalizados para o Leaflet */
        .pin-vermelho { color: #dc2626; } /* red-600 */
        .pin-verde { color: #16a34a; } /* green-600 */
        
        /* Cores da Bandeira SCC */
        .scc-blue { color: #312e81; } /* indigo-900 */
        .scc-green { color: #15803d; } /* green-700 */
        .scc-bg-blue { background-color: #312e81; }
        .scc-bg-green { background-color: #15803d; }
        
        /* Cores de Status */
        .status-red-text { color: #b91c1c; } /* red-700 */
        .status-red-bg { background-color: #fee2e2; } /* red-100 */
        .status-green-text { color: #14532d; } /* green-800 */
        .status-green-bg { background-color: #dcfce7; } /* green-100 */
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Cabeçalho -->
        <header class="scc-bg-blue p-6 rounded-lg shadow-lg mb-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white">Radar Cidadão</h1>
                    <p class="text-sm text-indigo-200">Santa Cruz do Capibaribe</p>
                </div>
                <div class="flex shadow-sm mt-4 md:mt-0">
                    <div class="w-12 h-8 bg-white rounded-l-sm"></div>
                    <div class="w-12 h-8 scc-bg-green rounded-r-sm"></div>
                </div>
            </div>
        </header>

        <!-- Estado de Carregamento / Erro -->
        <div id="feedback-container" class="text-center p-10 bg-white rounded-lg shadow-md">
            <p id="feedback-texto" class="text-lg font-medium text-gray-700">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                A carregar dados...
            </p>
        </div>

        <!-- Conteúdo Principal (Escondido por defeito) -->
        <main id="conteudo-principal" class="hidden">
            <!-- Métricas -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-sm font-medium text-gray-500 mb-2">OCORRÊNCIAS TOTAIS</h2>
                    <p id="metric-total" class="text-4xl font-bold scc-blue">0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md status-red-bg">
                    <h2 class="text-sm font-medium status-red-text mb-2">PENDENTES</h2>
                    <p id="metric-pendentes" class="text-4xl font-bold status-red-text">0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md status-green-bg">
                    <h2 class="text-sm font-medium status-green-text mb-2">RESOLVIDAS</h2>
                    <p id="metric-resolvidos" class="text-4xl font-bold status-green-text">0</p>
                </div>
            </section>

            <!-- Mapa e Gráficos -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Mapa (Ocupa 2 colunas) -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Mapa de Ocorrências</h2>
                    <div id="mapa"></div>
                </div>

                <!-- Gráficos (Ocupa 1 coluna) -->
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Status</h2>
                        <canvas id="grafico-status"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Tipos de Ocorrência</h2>
                        <canvas id="grafico-tipos"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // --- URL DA SUA NOVA APLICAÇÃO WEB (IMPLEMENTAÇÃO 5) ---
        const URL_DO_SEU_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbwh5TKwuHw9uVHesJMh8o0ETE4OevysuhmAq3jBAPAkiNZek153avwt3FLmlH--Vuze/exec";

        // Elementos do DOM
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackTexto = document.getElementById('feedback-texto');
        const conteudoPrincipal = document.getElementById('conteudo-principal');

        // Métricas
        const metricTotal = document.getElementById('metric-total');
        const metricPendentes = document.getElementById('metric-pendentes');
        const metricResolvidos = document.getElementById('metric-resolvidos');

        // Variáveis globais para mapa e gráficos (para destruir antes de recriar)
        let mapa = null;
        let graficoStatus = null;
        let graficoTipos = null;

        // Cores
        const corAzulSCC = '#312e81';
        const corVerdeSCC = '#15803d';
        const corAmarelaSCC = '#f59e0b'; // Cor para "Em Andamento"
        const corVermelhaStatus = '#dc2626';

        /**
         * Função Principal: Carrega os dados da API
         */
        async function carregarDados() {
            try {
                const response = await fetch(URL_DO_SEU_APPS_SCRIPT, {
                    cache: 'no-cache' // Garante que não usamos cache de erro
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const dadosJson = await response.json();

                if (dadosJson.status === 'success') {
                    // Sucesso! Vamos processar os dados
                    if (dadosJson.data && dadosJson.data.length > 0) {
                        processarDados(dadosJson.data);
                    } else {
                        // Sucesso, mas sem dados
                        mostrarFeedback('info', 'Nenhuma ocorrência encontrada.');
                        processarDados([]); // Mostra o dashboard vazio
                    }
                    // Mostra o conteúdo principal e esconde o 'loading'
                    feedbackContainer.classList.add('hidden');
                    conteudoPrincipal.classList.remove('hidden');

                } else {
                    // Erro retornado pela API (Ex: "Folha 'Dados' não encontrada")
                    throw new Error(dadosJson.message || 'Erro desconhecido da API');
                }

            } catch (error) {
                console.error("Erro detalhado ao buscar dados:", error);
                mostrarFeedback('error', `Não foi possível carregar os dados.<br><small>Detalhe: ${error.message}</small>`);
            }
        }

        /**
         * Mostra feedback de carregamento, erro ou informação
         */
        function mostrarFeedback(tipo, mensagem) {
            feedbackContainer.classList.remove('hidden');
            conteudoPrincipal.classList.add('hidden');
            
            let icone = '<i class="fas fa-spinner fa-spin mr-2"></i>'; // Padrão (loading)
            if (tipo === 'error') {
                icone = '<i class="fas fa-times-circle text-red-600 mr-2"></i>';
            } else if (tipo === 'info') {
                icone = '<i class="fas fa-info-circle text-blue-600 mr-2"></i>';
            }
            feedbackTexto.innerHTML = `${icone} ${mensagem}`;
        }

        /**
         * Processa os dados e constrói o dashboard
         */
        function processarDados(dados) {
            let total = dados.length;
            let pendentes = 0;
            let resolvidos = 0;
            let emAndamento = 0; // Futuro
            let tipos = {};

            // Filtra dados inválidos (caso haja linhas vazias)
            const dadosValidos = dados.filter(d => d.Latitude && d.Longitude && d.Tipo && d.Status);
            
            total = dadosValidos.length;

            dadosValidos.forEach(d => {
                // Processa Status
                if (d.Status === 'Pendente') {
                    pendentes++;
                } else if (d.Status === 'Resolvido') {
                    resolvidos++;
                }

                // Processa Tipos
                tipos[d.Tipo] = (tipos[d.Tipo] || 0) + 1;
            });

            // 1. Atualizar Métricas
            metricTotal.textContent = total;
            metricPendentes.textContent = pendentes;
            metricResolvidos.textContent = resolvidos;

            // 2. Criar Mapa
            // Centro aproximado de Santa Cruz do Capibaribe
            const centroMapa = [-7.954, -36.204]; 
            
            // Destrói mapa anterior se existir
            if (mapa) {
                mapa.remove();
            }
            
            mapa = L.map('mapa').setView(centroMapa, 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapa);

            // Ícones personalizados
            const iconeVermelho = L.divIcon({
                className: 'pin-vermelho',
                html: '<i class="fas fa-map-marker-alt fa-3x"></i>',
                iconSize: [30, 42],
                iconAnchor: [15, 42]
            });
            const iconeVerde = L.divIcon({
                className: 'pin-verde',
                html: '<i class="fas fa-map-marker-alt fa-3x"></i>',
                iconSize: [30, 42],
                iconAnchor: [15, 42]
            });

            // Adicionar marcadores
            dadosValidos.forEach(d => {
                const icone = (d.Status === 'Resolvido') ? iconeVerde : iconeVermelho;
                L.marker([d.Latitude, d.Longitude], { icon: icone })
                    .addTo(mapa)
                    .bindPopup(`<b>${d.Tipo}</b><br>${d.Descricao || 'Sem descrição'}<br>Status: ${d.Status}`);
            });
            
            // Ajustar o zoom para caber todos os marcadores (se houver marcadores)
            if (dadosValidos.length > 0) {
                 const group = new L.featureGroup(dadosValidos.map(d => L.marker([d.Latitude, d.Longitude])));
                 mapa.fitBounds(group.getBounds().pad(0.2));
            }


            // 3. Gráfico de Status (Doughnut)
            const ctxStatus = document.getElementById('grafico-status').getContext('2d');
            if (graficoStatus) graficoStatus.destroy(); // Destrói gráfico anterior
            
            graficoStatus = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Pendente', 'Resolvido'], // Simplificado
                    datasets: [{
                        label: 'Status',
                        data: [pendentes, resolvidos],
                        backgroundColor: [corVermelhaStatus, corVerdeSCC],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            // 4. Gráfico de Tipos (Bar)
            const ctxTipos = document.getElementById('grafico-tipos').getContext('2d');
            if (graficoTipos) graficoTipos.destroy(); // Destrói gráfico anterior
            
            graficoTipos = new Chart(ctxTipos, {
                type: 'bar',
                data: {
                    labels: Object.keys(tipos),
                    datasets: [{
                        label: 'Nº de Ocorrências',
                        data: Object.values(tipos),
                        backgroundColor: [ corAzulSCC, corVerdeSCC, corAmarelaSCC, corVermelhaStatus ], // Cores variadas
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y', // Gráfico de barras horizontal
                    scales: { 
                        y: { beginAtZero: true },
                        x: { ticks: { stepSize: 1 } } // Força a escala a ser 1, 2, 3...
                    }
                }
            });
        }

        // --- Iniciar o carregamento dos dados quando a página carregar ---
        document.addEventListener('DOMContentLoaded', carregarDados);

    </script>
</body>
</html>

