<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Cidadão - Santa Cruz do Capibaribe</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js (para os gráficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Fonte Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    
    <!-- SCRIPT DO GOOGLE MAPS (CARREGADO NO HEAD) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCOOXahjFFUioJ0V7aRAhR6h8cOdyYs-oc&v=weekly"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        #mapa { 
            height: 500px; 
            border-radius: 0.5rem; 
            background-color: #f3f4f6; 
        }
        .scc-bg-blue { background-color: #312e81; }
        .scc-bg-green { background-color: #15803d; }
        .scc-text-blue { color: #312e81; }
        .scc-text-green { color: #15803d; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        
        <!-- Cabeçalho -->
        <header class="scc-bg-blue p-6 rounded-lg shadow-lg mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Radar Cidadão</h1>
                    <p class="text-sm md:text-base text-indigo-200">Santa Cruz do Capibaribe</p>
                </div>
                <div class="flex shadow-sm">
                    <div class="w-8 h-5 bg-white rounded-l-sm"></div>
                    <div class="w-8 h-5 scc-bg-green rounded-r-sm"></div>
                </div>
            </div>
        </header>

        <!-- Feedback -->
        <div id="feedback-msg" class="mb-6 p-4 rounded-lg text-center font-medium bg-blue-100 text-blue-700 animate-pulse">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            A ligar à base de dados...
        </div>

        <!-- Métricas (V4.2) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
             <div class="bg-white p-4 md:p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <span class="text-sm font-medium text-gray-500">Total de Ocorrências</span>
                    <p id="total-metric" class="text-2xl md:text-3xl font-bold scc-text-blue">...</p>
                </div>
                <i class="fas fa-bullhorn fa-2x text-gray-300"></i>
            </div>
             <div class="bg-white p-4 md:p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <span class="text-sm font-medium text-gray-500">Pendentes</span>
                    <p id="pendente-metric" class="text-2xl md:text-3xl font-bold text-red-600">...</p>
                </div>
                <i class="fas fa-clock fa-2x text-gray-300"></i>
            </div>
             <div class="bg-white p-4 md:p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <span class="text-sm font-medium text-gray-500">Resolvidos</span>
                    <p id="resolvido-metric" class="text-2xl md:text-3xl font-bold scc-text-green">...</p>
                </div>
                <i class="fas fa-check-circle fa-2x text-gray-300"></i>
            </div>
        </div>


        <!-- Mapa e Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                
                <!-- Botão "Onde estou?" (V4.3) -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold scc-text-blue">Mapa de Ocorrências</h2>
                    <button id="find-me-btn" class="flex items-center px-4 py-2 bg-yellow-100 text-yellow-800 border border-yellow-300 rounded-lg shadow-sm hover:bg-yellow-200 transition-colors">
                        <i class="fas fa-location-crosshairs mr-2"></i>
                        Onde estou?
                    </button>
                </div>

                <div id="mapa"></div>
            </div>
            <div class="space-y-6">
                
                <!-- Gráficos (V4.2 com texto de ajuda) -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-1 scc-text-blue">Status Geral</h2>
                    <p class="text-xs italic text-gray-500 mb-3">Clique na legenda para filtrar</p>
                    <canvas id="grafico-status"></canvas>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-1 scc-text-blue">Tipos de Ocorrência</h2>
                    <p class="text-xs italic text-gray-500 mb-3">Clique na legenda para filtrar</p>
                    <canvas id="grafico-tipos"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão Flutuante "Reportar" (V4.1) -->
    <a href="reportar-ocorrencia.html" 
       title="Reportar Ocorrência"
       class="fixed bottom-6 right-6 flex flex-col items-center group no-underline transition-transform transform hover:scale-105"
       style="text-decoration: none;">
        
        <span class="text-red-600 text-sm font-bold mb-1" style="text-shadow: 0 0 5px white, 0 0 5px white, 0 0 5px white;">
            Nova Ocorrência
        </span>
        
        <div class="w-16 h-16 bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg group-hover:bg-red-700 transition-colors">
            <i class="fas fa-plus fa-2x"></i>
        </div>
    </a>

    
    <!-- SDKs do Firebase (Módulos v9) -->
    <script type="module">
        // Importa as funções necessárias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- A TUA CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyDM0CvmTJMIbQudEndIJYO55r0qz30V-Sw",
          authDomain: "cidadao-scc.firebaseapp.com",
          projectId: "cidadao-scc",
          storageBucket: "cidadao-scc.firebasestorage.app",
          messagingSenderId: "542851157019",
          appId: "1:542851157019:web:60e9b0eb957b5a3425fcbe",
          measurementId: "G-XYKDFXRPFX"
        };

        // --- Inicializa o Firebase e o Firestore ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Elementos do DOM ---
        let feedbackMsg, totalMetric, pendenteMetric, resolvidoMetric, findMeBtn;
        let graficoStatus = null;
        let graficoTipos = null;

        // --- Variáveis do Mapa (Google Maps) ---
        let mapa = null; 
        let googleMarkers = []; 
        let infoWindow = null; 
        let userLocationMarker = null; 

        // --- Variáveis de Lógica (do teu V3 funcional) ---
        let todosOsDados = [];
        let filtrosStatus = { "Pendente": true, "Em Andamento": true, "Resolvido": true };
        let filtrosTipo = {}; 

        // Cores
        const corAzulSCC = '#312e81';
        const corVerdeSCC = '#15803d';
        const corAmarelaSCC = '#f59e0b';
        const corVermelhaStatus = '#dc2626';

        // URLs dos Ícones do Google Maps
        const iconUrlBase = "http://maps.google.com/mapfiles/ms/icons/";
        const icons = {
            "Pendente": iconUrlBase + "red-dot.png",
            "Em Andamento": iconUrlBase + "yellow-dot.png",
            "Resolvido": iconUrlBase + "green-dot.png",
            "User": {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: "#4285F4", 
                fillOpacity: 1,
                strokeColor: "white",
                strokeWeight: 2,
            }
        };

        // V6: DADOS DO TEU POLÍGONO KML
        const poligonoBairroCentro = [
          { lat: -7.949892405700667, lng: -36.21664300943785 },
          { lat: -7.943215223432971, lng: -36.21676433973632 },
          { lat: -7.943200917962861, lng: -36.21890943470739 },
          { lat: -7.949706077896568, lng: -36.21870397293382 },
          { lat: -7.949892405700667, lng: -36.21664300943785 } // Fecha o polígono
        ];


        // --- 1. Função de Feedback ---
        function mostrarFeedback(tipo, mensagem) {
            if (!feedbackMsg) feedbackMsg = document.getElementById('feedback-msg');
            if (!feedbackMsg) return; // Segurança
            feedbackMsg.classList.remove('hidden', 'bg-blue-100', 'text-blue-700', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'animate-pulse');
            if (tipo === 'loading') {
                feedbackMsg.classList.add('bg-blue-100', 'text-blue-700', 'animate-pulse');
            } else if (tipo === 'error') {
                feedbackMsg.classList.add('bg-red-100', 'text-red-700');
            } else { // info ou success
                feedbackMsg.classList.add('bg-green-100', 'text-green-700');
            }
            feedbackMsg.innerHTML = mensagem; 
            feedbackMsg.classList.remove('hidden');
        }

        
        // --- 2. Função Centralizada de Atualização (A tua lógica V3) ---
        function aplicarFiltrosEAtualizarDashboard() {
            
            const dadosFiltradosFinal = todosOsDados.filter(item => {
                const status = item.status || 'Pendente';
                const tipo = item.tipo;
                if (tipo && filtrosTipo[tipo] === undefined) { filtrosTipo[tipo] = true; }
                return filtrosStatus[status] && filtrosTipo[tipo];
            });

            atualizarMapaPins(dadosFiltradosFinal);
            atualizarMetricas(dadosFiltradosFinal);
            
            const dadosFiltradosPorTipo = todosOsDados.filter(item => {
                const tipo = item.tipo;
                if (tipo && filtrosTipo[tipo] === undefined) { filtrosTipo[tipo] = true; }
                return filtrosTipo[tipo];
            });
            atualizarGraficoStatus(dadosFiltradosPorTipo);
            
            const dadosFiltradosPorStatus = todosOsDados.filter(item => {
                return filtrosStatus[item.status || 'Pendente']; 
            });
            atualizarGraficoTipos(dadosFiltradosPorStatus);
        }

        // --- 3. Funções de Atualização Específicas ---

        // ATUALIZADO para Google Maps
        function atualizarMapaPins(dados) {
            if (!mapa) inicializarMapa(); 
            googleMarkers.forEach(marker => marker.setMap(null));
            googleMarkers = [];
            if (!infoWindow) infoWindow = new google.maps.InfoWindow();

            dados.forEach(item => {
                try {
                    const lat = parseFloat(item.latitude);
                    const lon = parseFloat(item.longitude);
                    if (isNaN(lat) || isNaN(lon)) return; 
                    const iconUrl = icons[item.status] || icons["Pendente"];
                    const marcador = new google.maps.Marker({
                        position: { lat: lat, lng: lon },
                        map: mapa,
                        icon: iconUrl,
                        animation: google.maps.Animation.DROP 
                    });
                    const infoConteudo = `
                        <div style="font-family: Inter, sans-serif; padding: 5px;">
                            <strong style="color: ${corAzulSCC};">${item.tipo || 'N/D'}</strong><br>
                            <strong>Status:</strong> ${item.status || 'N/D'}<br>
                            <strong>Endereço:</strong> ${item.endereco_formatado || 'N/D'}<br>
                            <strong>Data:</strong> ${item.timestamp ? item.timestamp.toDate().toLocaleDateString('pt-BR') : 'N/D'}<br>
                            <strong>Descrição:</strong> ${item.descricao || 'N/D'}
                        </div>
                    `;
                    marcador.addListener('click', () => {
                        infoWindow.setContent(infoConteudo);
                        infoWindow.open(mapa, marcador);
                    });
                    googleMarkers.push(marcador);
                } catch(e) { console.warn("Erro ao adicionar pino:", e); }
            });
        }

        // A tua função de Métricas
        function atualizarMetricas(dados) {
            let total = dados.length;
            let pendentes = 0, resolvidos = 0, emAndamento = 0; 
            dados.forEach(item => {
                if (item.status === 'Resolvido') { resolvidos++; }
                else if (item.status === 'Em Andamento') { emAndamento++; }
                else { pendentes++; }
            });

            if (totalMetric) totalMetric.textContent = total;
            if (pendenteMetric) pendenteMetric.textContent = pendentes;
            if (resolvidoMetric) resolvidoMetric.textContent = resolvidos;
        }

        // --- 4. Funções de Criação/Atualização dos Gráficos ---

        // A tua função de Gráfico de Status (COM O CLIQUE DE "TRACEJADO")
        function atualizarGraficoStatus(dados) {
            let pendentes = 0, resolvidos = 0, emAndamento = 0; 
            dados.forEach(item => {
                if (item.status === 'Resolvido') { resolvidos++; }
                else if (item.status === 'Em Andamento') { emAndamento++; }
                else { pendentes++; }
            });

            if (graficoStatus) {
                graficoStatus.data.datasets[0].data = [pendentes, emAndamento, resolvidos];
                graficoStatus.update();
            } else {
                const ctxStatus = document.getElementById('grafico-status');
                if (!ctxStatus) return; 
                
                graficoStatus = new Chart(ctxStatus.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Pendente', 'Em Andamento', 'Resolvido'],
                        datasets: [{
                            label: 'Status',
                            data: [pendentes, emAndamento, resolvidos],
                            backgroundColor: [corVermelhaStatus, corAmarelaSCC, corVerdeSCC],
                            hoverOffset: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                // A LÓGICA DE FILTRO CORRETA (do teu V3)
                                onClick: (e, legendItem, legend) => {
                                    legendItem.hidden = !legendItem.hidden;
                                    filtrosStatus[legendItem.text] = !legendItem.hidden; 
                                    legend.chart.toggleDataVisibility(legendItem.index);
                                    legend.chart.update();
                                    aplicarFiltrosEAtualizarDashboard();
                                }
                            }
                        }
                    }
                });
            }
        }

        // A tua função de Gráfico de Tipos (COM O CLIQUE DE "TRACEJADO")
        function atualizarGraficoTipos(dados) {
            let tipos = {};
            dados.forEach(item => {
                if (item.tipo) { tipos[item.tipo] = (tipos[item.tipo] || 0) + 1; }
            });

            const coresBase = [corAzulSCC, corVerdeSCC, corAmarelaSCC, corVermelhaStatus, '#6366f1', '#ec4899'];
            
            const datasets = Object.keys(tipos).map((tipo, index) => {
                return {
                    label: tipo, 
                    data: [tipos[tipo]], 
                    backgroundColor: coresBase[index % coresBase.length],
                    hidden: !filtrosTipo[tipo] 
                };
            });

            if (graficoTipos) {
                graficoTipos.data.datasets = datasets;
                graficoTipos.update();
            } else {
                const ctxTipos = document.getElementById('grafico-tipos');
                if (!ctxTipos) return; 

                graficoTipos = new Chart(ctxTipos.getContext('2d'), {
                    type: 'bar', 
                    data: {
                        labels: ['Tipos'], 
                        datasets: datasets 
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true, 
                                onClick: (e, legendItem, legend) => {
                                    filtrosTipo[legendItem.text] = !filtrosTipo[legendItem.text]; 
                                    aplicarFiltrosEAtualizarDashboard();
                                }
                            }
                        },
                        scales: { 
                            y: { beginAtZero: true },
                            x: { ticks: { display: false } } 
                        }
                    }
                });
            }
        }
        
        // --- 5. Inicializar Mapa (ALTERADO para Google Maps) ---
        function inicializarMapa() {
            if (mapa) return; 
            const sccCoords = { lat: -7.954, lng: -36.204 }; 
            const mapElement = document.getElementById('mapa');
            if (!mapElement) return; 
            
            mapa = new google.maps.Map(mapElement, {
                center: sccCoords,
                zoom: 14,
                mapTypeId: 'hybrid', // MODO HÍBRIDO (Satélite + Ruas)
                mapId: "RADAR_CIDADAO_SCC_STYLE" 
            });

            // #############################################
            // ### V7: O TEU POLÍGONO (COM OS AFINOS) ###
            // #############################################
            const bairroPoligono = new google.maps.Polygon({
                paths: poligonoBairroCentro,
                strokeColor: "#00FFFF", // Ciano (para destacar)
                strokeOpacity: 0.9,
                strokeWeight: 2,
                fillColor: "#00FFFF", // Ciano
                // 1. 20% mais transparente (0.15 -> 0.12)
                fillOpacity: 0.12 
            });
            bairroPoligono.setMap(mapa);

            // 2. Torna o polígono clicável com o balão
            // (Usa a InfoWindow global para não conflitar com os pinos)
            if (!infoWindow) infoWindow = new google.maps.InfoWindow();
            
            bairroPoligono.addListener("click", (e) => {
                infoWindow.setContent(
                    // O teu texto, com o estilo pastel que pediste
                    `<div style="font-family: Inter, sans-serif; font-weight: bold; color: #312e81;">Loteamento - São Miguel 1</div>`
                );
                // Tenta abrir no local do clique; se não for possível, abre no centro do polígono
                infoWindow.setPosition(e.latLng || sccCoords); // sccCoords é um fallback
                infoWindow.open(mapa);
            });
            // #############################################
        }

        // --- 6. LIGAR AO FIREBASE (Ponto de Entrada) ---
        // A TUA ESTRUTURA `window.onload` (QUE FUNCIONA)
        window.onload = () => {
            feedbackMsg = document.getElementById('feedback-msg');
            totalMetric = document.getElementById('total-metric');
            pendenteMetric = document.getElementById('pendente-metric');
            resolvidoMetric = document.getElementById('resolvido-metric');
            findMeBtn = document.getElementById('find-me-btn'); 
            
            try {
                if (typeof google === 'object' && typeof google.maps === 'object') {
                    inicializarMapa(); 
                    conectarAoFirestore(); 
                    adicionarEventoFindMe(); 
                } else {
                    mostrarFeedback('error', 'Não foi possível carregar o Google Maps.');
                }
            } catch(e) {
                console.error("Erro geral:", e);
                mostrarFeedback('error', 'Ocorreu um erro ao carregar a aplicação.');
            }
        };
        // #############################################

        // --- 7. Função de Ligação ao Firestore (do teu V3) ---
        function conectarAoFirestore() {
            const q = query(collection(db, "ocorrencias"));
            onSnapshot(q, (snapshot) => {
                todosOsDados = []; 
                let tiposExistentes = Object.keys(filtrosTipo);
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    todosOsDados.push(data); 
                    if (data.tipo && !tiposExistentes.includes(data.tipo)) {
                         filtrosTipo[data.tipo] = true; 
                    }
                });

                if (!graficoStatus) atualizarGraficoStatus(todosOsDados);
                if (!graficoTipos) atualizarGraficoTipos(todosOsDados);

                aplicarFiltrosEAtualizarDashboard(); 
                if (todosOsDados.length === 0) {
                    mostrarFeedback('info', 'Nenhuma ocorrência encontrada.');
                } else {
                    feedbackMsg.classList.add('hidden'); 
                }
            }, (error) => {
                console.error("Erro ao ligar ao Firestore: ", error);
                mostrarFeedback('error', `Não foi possível ligar à base de dados. <br><small>Verifique as regras do Firestore.</small>`);
            });
        }

        // --- 8. Função para o Botão "Onde estou?" ---
        function adicionarEventoFindMe() {
            if (!findMeBtn) return; 
            
            findMeBtn.addEventListener('click', () => {
                if ('geolocation' in navigator) {
                    findMeBtn.disabled = true;
                    findMeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> A localizar...';
                    
                    navigator.geolocation.getCurrentPosition((posicao) => {
                        const userPos = {
                            lat: posicao.coords.latitude,
                            lng: posicao.coords.longitude
                        };
                        
                        mapa.setCenter(userPos);
                        mapa.setZoom(17); 

                        if (userLocationMarker) {
                            userLocationMarker.setPosition(userPos);
                        } else {
                            userLocationMarker = new google.maps.Marker({
                                position: userPos,
                                map: mapa,
                                icon: icons["User"], // Usa a "bolinha azul"
                                title: "Você está aqui"
                            });
                        }
                        
                        findMeBtn.disabled = false;
                        findMeBtn.innerHTML = '<i class="fas fa-location-crosshairs mr-2"></i> Onde estou?';

                    }, (erro) => {
                        console.error("Erro ao localizar:", erro);
                        mostrarFeedback('error', 'Não foi possível obter a sua localização. Verifique as permissões.');
                        findMeBtn.disabled = false;
                        findMeBtn.innerHTML = '<i class="fas fa-location-crosshairs mr-2"></i> Onde estou?';
                    });
                } else {
                    mostrarFeedback('error', 'Geolocalização não é suportada neste navegador.');
                }
            });
        }
        
    </script>
    
    <!-- O script do Google Maps foi movido para o <head> -->

</body>
</html>
