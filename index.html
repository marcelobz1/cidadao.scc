<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Cidadão - Santa Cruz do Capibaribe</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS (para o mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js (para os gráficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome (Ícones) - ATUALIZADO -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Fonte Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        #mapa { 
            height: 500px; 
            border-radius: 0.5rem; 
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Ícones personalizados para o Leaflet */
        .pin-vermelho { color: #dc2626; } /* red-600 */
        .pin-amarelo { color: #f59e0b; } /* amber-500 */
        .pin-verde { color: #16a34a; }  /* green-600 */
        
        /* Cores da Bandeira SCC */
        .scc-bg-blue { background-color: #312e81; } /* indigo-900 */
        .scc-bg-green { background-color: #15803d; } /* green-700 */
        .scc-text-blue { color: #312e81; }
        .scc-text-green { color: #15803d; }

        /* Animação de carregamento */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        
        <!-- Cabeçalho -->
        <header class="scc-bg-blue p-6 rounded-lg shadow-lg mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Radar Cidadão</h1>
                    <p class="text-sm md:text-base text-indigo-200">Santa Cruz do Capibaribe</p>
                </div>
                <!-- Mini Bandeira -->
                <div class="flex shadow-sm">
                    <div class="w-8 h-5 bg-white rounded-l-sm"></div>
                    <div class="w-8 h-5 scc-bg-green rounded-r-sm"></div>
                </div>
            </div>
        </header>

        <!-- Feedback (Carregando / Erro) -->
        <div id="feedback-msg" class="hidden mb-6 p-4 rounded-lg text-center font-medium"></div>

        <!-- Métricas Principais -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <span class="text-sm font-medium text-gray-500">Total de Ocorrências</span>
                    <p id="total-metric" class="text-3xl font-bold scc-text-blue">...</p>
                </div>
                <i class="fas fa-bullhorn fa-2x text-gray-300"></i>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <span class="text-sm font-medium text-gray-500">Pendentes</span>
                    <p id="pendente-metric" class="text-3xl font-bold text-red-600">...</p>
                </div>
                <i class="fas fa-clock fa-2x text-gray-300"></i>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <span class="text-sm font-medium text-gray-500">Resolvidos</span>
                    <p id="resolvido-metric" class="text-3xl font-bold scc-text-green">...</p>
                </div>
                <i class="fas fa-check-circle fa-2x text-gray-300"></i>
            </div>
        </div>

        <!-- Mapa e Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Coluna do Mapa (ocupa 2/3 no desktop) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 scc-text-blue">Mapa de Ocorrências</h2>
                <div id="mapa"></div>
            </div>

            <!-- Coluna dos Gráficos (ocupa 1/3 no desktop) -->
            <div class="space-y-6">
                <!-- Gráfico de Status -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 scc-text-blue">Status Geral</h2>
                    <canvas id="grafico-status"></canvas>
                </div>
                <!-- Gráfico de Tipos -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 scc-text-blue">Tipos de Ocorrência</h2>
                    <canvas id="grafico-tipos"></canvas>
                </div>
            </div>
        </div>

    </div>

    <!-- Leaflet JS (para o mapa) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- URL DA SUA NOVA API (Apps Script) ---
        const URL_DO_SEU_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbz_Awu8N7SylgQ2ek2zkNSb1DeMf5NOlxJyahD0lJRPpcY-vGdtDcuRziKqScB86PILlA/exec";

        // Elementos do DOM
        const feedbackMsg = document.getElementById('feedback-msg');
        const totalMetric = document.getElementById('total-metric');
        const pendenteMetric = document.getElementById('pendente-metric');
        const resolvidoMetric = document.getElementById('resolvido-metric');
        
        // --- CORREÇÃO: Declarar variáveis do mapa e gráficos como globais (nulas) ---
        let mapa = null;
        let layerGrupo = null;
        let graficoStatus = null;
        let graficoTipos = null;

        // Cores
        const corAzulSCC = '#312e81';
        const corVerdeSCC = '#15803d';
        const corAmarelaSCC = '#f59e0b'; // amber-500
        const corVermelhaStatus = '#dc2626'; // red-600

        // --- 1. Inicializar Mapa (AGORA É UMA FUNÇÃO) ---
        function inicializarMapa() {
            if (mapa) return; // Não inicializa duas vezes
            
            // Coordenadas de Santa Cruz do Capibaribe
            const sccCoords = [-7.954, -36.204];
            mapa = L.map('mapa').setView(sccCoords, 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapa);
            layerGrupo = L.layerGroup().addTo(mapa); // Grupo para limpar os pinos
        }

        // --- 2. Função de Feedback (Carregando / Erro / Info) ---
        function mostrarFeedback(tipo, mensagem) {
            feedbackMsg.classList.remove('hidden', 'bg-blue-100', 'text-blue-700', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'animate-pulse');
            
            if (tipo === 'loading') {
                feedbackMsg.classList.add('bg-blue-100', 'text-blue-700', 'animate-pulse');
            } else if (tipo === 'error') {
                feedbackMsg.classList.add('bg-red-100', 'text-red-700');
            } else { // info
                feedbackMsg.classList.add('bg-green-100', 'text-green-700');
            }
            feedbackMsg.innerHTML = mensagem; // Usamos innerHTML para o <small>
            feedbackMsg.classList.remove('hidden');
        }

        // --- 3. Carregar Dados ---
        async function carregarDados() {
            // --- CORREÇÃO: Inicializa o mapa ANTES de fazer o fetch ---
            // Como esta função só corre no DOMContentLoaded, é seguro
            try {
                inicializarMapa();
            } catch (e) {
                console.error("Falha ao inicializar o mapa:", e);
                mostrarFeedback('error', `Falha ao carregar o mapa. Verifique a consola.`);
                return;
            }

            mostrarFeedback('loading', 'A carregar dados...');
            
            try {
                // cache: 'no-cache' garante que vamos buscar dados novos
                const response = await fetch(URL_DO_SEU_APPS_SCRIPT, {
                    method: 'GET',
                    cache: 'no-cache' 
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
                }

                const dadosJson = await response.json();

                if (dadosJson.status === 'success') {
                    // Sucesso! Vamos processar os dados
                    if (dadosJson.data && dadosJson.data.length > 0) {
                        feedbackMsg.classList.add('hidden'); // Esconde feedback se deu certo
                        processarDados(dadosJson.data);
                    } else {
                        // Sucesso, mas sem dados
                        mostrarFeedback('info', 'Nenhuma ocorrência encontrada.');
                        processarDados([]); // Processa um array vazio
                    }
                } else {
                    // Erro vindo do Apps Script
                    throw new Error(dadosJson.message || 'Erro desconhecido do script');
                }
            
            } catch (error) {
                console.error("Erro detalhado ao carregar dados:", error);
                mostrarFeedback('error', `Não foi possível carregar os dados.<br><small>Detalhe: ${error.message}</small>`);
                // Limpa métricas em caso de erro
                totalMetric.textContent = 'Erro';
                pendenteMetric.textContent = 'Erro';
                resolvidoMetric.textContent = 'Erro';
            }
        }

        // --- 4. Processar e Exibir Dados ---
        function processarDados(dados) {
            // Agora 'layerGrupo' está garantido que existe
            layerGrupo.clearLayers();

            // Contadores
            let total = dados.length;
            let pendentes = 0;
            let resolvidos = 0;
            let emAndamento = 0; 
            let tipos = {};

            // Ícones do Mapa
            const iconPendente = L.divIcon({
                html: '<i class="fas fa-map-pin fa-3x pin-vermelho"></i>',
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });
            const iconResolvido = L.divIcon({
                html: '<i class="fas fa-map-pin fa-3x pin-verde"></i>',
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });

            // Loop pelos dados
            dados.forEach(item => {
                // 1. Contagem de Status
                if (item.Status === 'Resolvido') {
                    resolvidos++;
                } else if (item.Status === 'Em Andamento') {
                    emAndamento++;
                } else {
                    pendentes++; 
                }

                // 2. Contagem de Tipos
                tipos[item.Tipo] = (tipos[item.Tipo] || 0) + 1;

                // 3. Adicionar Pinos ao Mapa
                try {
                    const lat = parseFloat(item.Latitude);
                    const lon = parseFloat(item.Longitude);
                    
                    if (isNaN(lat) || isNaN(lon)) return; 

                    const icon = (item.Status === 'Resolvido') ? iconResolvido : iconPendente;
                    const marcador = L.marker([lat, lon], { icon: icon });
                    
                    marcador.bindPopup(`
                        <strong class="scc-text-blue">${item.Tipo}</strong><br>
                        <strong>Status:</strong> ${item.Status}<br>
                        <strong>Data:</strong> ${new Date(item.Timestamp).toLocaleDateString('pt-BR')}<br>
                        <strong>Descrição:</strong> ${item.Descricao || 'N/D'}
                    `);
                    
                    layerGrupo.addLayer(marcador);

                } catch(e) {
                    console.warn("Erro ao adicionar pino para o item:", item, e);
                }
            });

            // --- 5. Atualizar Métricas e Gráficos ---

            // Métricas
            totalMetric.textContent = total;
            pendenteMetric.textContent = pendentes;
            resolvidoMetric.textContent = resolvidos;

            // Gráfico de Status (Doughnut)
            const ctxStatus = document.getElementById('grafico-status').getContext('2d');
            if (graficoStatus) graficoStatus.destroy(); // Destrói gráfico anterior se existir
            graficoStatus = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Pendente', 'Em Andamento', 'Resolvido'],
                    datasets: [{
                        label: 'Status',
                        data: [pendentes, emAndamento, resolvidos],
                        backgroundColor: [corVermelhaStatus, corAmarelaSCC, corVerdeSCC],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            // Gráfico de Tipos (Bar)
            const ctxTipos = document.getElementById('grafico-tipos').getContext('2d');
            if (graficoTipos) graficoTipos.destroy(); // Destrói gráfico anterior se existir
            graficoTipos = new Chart(ctxTipos, {
                type: 'bar',
                data: {
                    labels: Object.keys(tipos),
                    datasets: [{
                        label: 'Nº de Ocorrências',
                        data: Object.values(tipos),
                        backgroundColor: [ corAzulSCC, corVerdeSCC, corAmarelaSCC, corVermelhaStatus ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y', // Gráfico de barras horizontal
                    scales: { 
                        y: { beginAtZero: true },
                        // --- CORREÇÃO: Evitar erro de 'stepSize' com dados vazios ---
                        x: { ticks: { 
                            stepSize: (total > 0) ? 1 : undefined 
                        } } 
                    }
                }
            });
        }
        
        // --- 6. Carregar os dados quando a página abrir ---
        document.addEventListener('DOMContentLoaded', carregarDados);

    </script>
</body>
</html>

