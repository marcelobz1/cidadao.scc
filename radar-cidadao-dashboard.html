<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Cidadão - Santa Cruz do Capibaribe</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS (para o mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js (para os gráficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome (Ícones) - ATUALIZADO -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Fonte Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        #mapa { 
            height: 500px; 
            border-radius: 0.5rem; 
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Ícones personalizados para o Leaflet */
        .pin-vermelho { color: #DC2626; } /* red-600 */
        .pin-amarelo { color: #F59E0B; } /* amber-500 */
        /* Verde da bandeira */
        .pin-verde { color: #15803d; } /* green-700 */

        /* Cores personalizadas da bandeira */
        .scc-blue { color: #312e81; } /* indigo-900 */
        .scc-green { color: #15803d; } /* green-700 */
        .scc-bg-blue { background-color: #312e81; }
        .scc-bg-green { background-color: #15803d; }

        /* Animação de loading simples */
        .spinner-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- HEADER -->
        <header class="mb-8 p-6 bg-white rounded-lg shadow-md">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold scc-blue">Radar Cidadão</h1>
                    <p class="text-lg text-gray-600">Santa Cruz do Capibaribe</p>
                </div>
                 <!-- Mini-bandeira estilizada -->
                <div class="flex mt-4 md:mt-0 shadow-sm">
                    <div class="w-12 h-8 scc-bg-blue rounded-l-sm"></div>
                    <div class="w-12 h-8 bg-white"></div>
                    <div class="w-12 h-8 scc-bg-green rounded-r-sm"></div>
                </div>
            </div>
        </header>

        <!-- Métricas Principais -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <div class="text-sm font-medium text-gray-500">Total de Ocorrências</div>
                    <div id="total-metric" class="text-3xl font-bold scc-blue spinner-pulse">...</div>
                </div>
                <i class="fas fa-bullhorn fa-2x text-indigo-400 opacity-50"></i>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <div class="text-sm font-medium text-gray-500">Pendentes</div>
                    <div id="pendente-metric" class="text-3xl font-bold text-red-600 spinner-pulse">...</div>
                </div>
                <i class="fas fa-clock fa-2x text-red-400 opacity-50"></i>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <div class="text-sm font-medium text-gray-500">Resolvidas</div>
                    <div id="resolvido-metric" class="text-3xl font-bold scc-green spinner-pulse">...</div>
                </div>
                <i class="fas fa-check-circle fa-2x text-green-400 opacity-50"></i>
            </div>
        </div>

        <!-- Mensagem de Erro/Loading -->
        <div id="loading-msg" class="text-center p-6 bg-white rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold scc-blue flex items-center justify-center">
                <i class="fas fa-spinner fa-spin mr-3"></i> A carregar dados reais...
            </h2>
        </div>
        <div id="error-msg" class="hidden text-center p-6 bg-red-100 text-red-700 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold flex items-center justify-center">
                <i class="fas fa-exclamation-triangle mr-3"></i> Não foi possível carregar os dados.
            </h2>
            <p id="error-details"></p>
        </div>


        <!-- Mapa e Gráficos -->
        <div id="dashboard-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Coluna do Mapa (ocupa 2 colunas no lg) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Mapa de Ocorrências</h2>
                <div id="mapa" class="w-full z-0"></div>
            </div>

            <!-- Coluna dos Gráficos -->
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ocorrências por Tipo</h2>
                    <canvas id="grafico-tipos"></canvas>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Status Geral</h2>
                    <canvas id="grafico-status"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS (para o mapa) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- URL DA API (Apps Script) ---
        // ESTA URL DEVE SER A MESMA DO SEU FICHEIRO DE INPUT
        const URL_DO_SEU_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbwXOVccvx8EBVPd0pHu-wxPKL4Uri_1OtAd2aJMO83AfachaAPZSk_jXTo77ABGwzTh/exec";

        // --- CORES DA BANDEIRA PARA OS GRÁFICOS ---
        const corAzulSCC = '#312e81'; // indigo-900
        const corVerdeSCC = '#15803d'; // green-700
        const corAmarelaSCC = '#f59e0b'; // amber-500 (das estrelas)
        const corVermelhaStatus = '#DC2626'; // red-600 (Pendente)

        // Variáveis globais para os gráficos
        let graficoStatus = null;
        let graficoTipos = null;

        // --- FUNÇÃO PRINCIPAL PARA CARREGAR DADOS REAIS ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingMsg = document.getElementById('loading-msg');
            const errorMsg = document.getElementById('error-msg');
            const errorDetails = document.getElementById('error-details');
            const dashboardContent = document.getElementById('dashboard-content');
            
            try {
                // 1. Buscar dados reais do Apps Script (GET request)
                const response = await fetch(URL_DO_SEU_APPS_SCRIPT);
                
                if (!response.ok) {
                    throw new Error(`Erro na rede: ${response.status} ${response.statusText}`);
                }

                const resultado = await response.json();

                if (resultado.status !== 'success') {
                    throw new Error(resultado.message || 'O script retornou um erro.');
                }

                const dadosOcorrencias = resultado.data;

                // 2. Esconder loading, mostrar dashboard
                loadingMsg.classList.add('hidden');
                dashboardContent.classList.remove('hidden');

                // 3. Iniciar o dashboard com os dados reais
                iniciarDashboard(dadosOcorrencias);

            } catch (error) {
                // --- MELHORIA DE DEBUG ---
                // Esta linha imprime o erro *detalhado* na consola do navegador
                console.error("Erro detalhado ao carregar dados:", error); 
                
                loadingMsg.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                errorDetails.textContent = `(${error.message})`; // Ex: (Failed to fetch)
            }
        });

        // --- FUNÇÃO PARA INICIAR O DASHBOARD (MAPA, MÉTRICAS, GRÁFICOS) ---
        function iniciarDashboard(dadosOcorrencias) {
            
            // --- 1. Inicializar o Mapa ---
            // Coordenadas de Santa Cruz do Capibaribe
            const centroMapa = [-7.947, -36.204]; 
            const mapa = L.map('mapa').setView(centroMapa, 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapa);

            // Define ícones personalizados
            const iconePendente = L.divIcon({ className: 'pin-vermelho', html: '<i class="fas fa-map-pin fa-3x"></i>', iconSize: [30, 30], iconAnchor: [15, 30] });
            const iconeEmAndamento = L.divIcon({ className: 'pin-amarelo', html: '<i class="fas fa-map-pin fa-3x"></i>', iconSize: [30, 30], iconAnchor: [15, 30] });
            const iconeResolvido = L.divIcon({ className: 'pin-verde', html: '<i class="fas fa-map-pin fa-3x"></i>', iconSize: [30, 30], iconAnchor: [15, 30] });

            if (!dadosOcorrencias || dadosOcorrencias.length === 0) {
                console.log("Nenhuma ocorrência para mostrar.");
                // Pode adicionar uma mensagem no HTML se quiser
            } else {
                // Adiciona os pinos (marcadores) ao mapa
                dadosOcorrencias.forEach(ocorrencia => {
                    // Validação de dados (para evitar erros se lat/long estiverem em falta)
                    if (!ocorrencia.latitude || !ocorrencia.longitude) {
                        console.warn("Ocorrência ignorada (sem lat/long):", ocorrencia.tipo);
                        return; // Pula esta ocorrência
                    }

                    let icone;
                    const status = ocorrencia.status || 'Pendente'; // Trata status vazio como Pendente

                    if (status === 'Resolvido') icone = iconeResolvido;
                    else if (status === 'Em Andamento') icone = iconeEmAndamento;
                    else icone = iconePendente; 

                    L.marker([ocorrencia.latitude, ocorrencia.longitude], { icon: icone })
                        .addTo(mapa)
                        .bindPopup(`<b>${ocorrencia.tipo}</b><br>Status: ${status}<br><small>${ocorrencia.descricao || 'Sem descrição'}</small>`);
                });
            }

            // --- 2. Processar Dados para Métricas e Gráficos ---
            let total = dadosOcorrencias.length;
            let pendentes = 0;
            let resolvidos = 0;
            let emAndamento = 0;
            let tipos = {};

            dadosOcorrencias.forEach(o => {
                const status = o.status || 'Pendente'; 
                if (status === 'Pendente') pendentes++;
                else if (status === 'Em Andamento') emAndamento++;
                else if (status === 'Resolvido') resolvidos++;
                
                // Agrupa tipos (ignora se o tipo estiver vazio)
                if (o.tipo) {
                    tipos[o.tipo] = (tipos[o.tipo] || 0) + 1;
                }
            });

            // Atualiza métricas
            document.getElementById('total-metric').textContent = total;
            document.getElementById('pendente-metric').textContent = pendentes;
            document.getElementById('resolvido-metric').textContent = resolvidos;
            // Remove animação de pulso das métricas
            document.querySelectorAll('.spinner-pulse').forEach(el => el.classList.remove('spinner-pulse'));

            // --- 3. Renderizar Gráficos ---
            
            // Gráfico de Status (Doughnut)
            const ctxStatus = document.getElementById('grafico-status').getContext('2d');
            if (graficoStatus) graficoStatus.destroy(); // Destrói gráfico anterior se existir
            graficoStatus = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Pendente', 'Em Andamento', 'Resolvido'],
                    datasets: [{
                        label: 'Status',
                        data: [pendentes, emAndamento, resolvidos],
                        backgroundColor: [corVermelhaStatus, corAmarelaSCC, corVerdeSCC],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            // Gráfico de Tipos (Bar)
            const ctxTipos = document.getElementById('grafico-tipos').getContext('2d');
            if (graficoTipos) graficoTipos.destroy(); // Destrói gráfico anterior se existir
            graficoTipos = new Chart(ctxTipos, {
                type: 'bar',
                data: {
                    labels: Object.keys(tipos),
                    datasets: [{
                        label: 'Nº de Ocorrências',
                        data: Object.values(tipos),
                        backgroundColor: [ corAzulSCC, corVerdeSCC, corAmarelaSCC, corVermelhaStatus ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y', // Gráfico de barras horizontal
                    scales: { 
                        y: { beginAtZero: true },
                        x: { ticks: { stepSize: 1 } } // Força a escala a ser 1, 2, 3...
                    }
                }
            });
        }
    </script>
</body>
</html>

        // Variáveis globais para os gráficos
        let graficoStatus = null;
        let graficoTipos = null;

        // --- DADOS DE SIMULAÇÃO REMOVIDOS ---
        // const dadosOcorrencias = [ ... ];

        // --- FUNÇÃO PRINCIPAL PARA CARREGAR DADOS REAIS ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingMsg = document.getElementById('loading-msg');
            const errorMsg = document.getElementById('error-msg');
            const errorDetails = document.getElementById('error-details');
            const dashboardContent = document.getElementById('dashboard-content');
            
            try {
                // 1. Buscar dados reais do Apps Script (GET request)
                const response = await fetch(URL_DO_SEU_APPS_SCRIPT);
                
                if (!response.ok) {
                    throw new Error(`Erro na rede: ${response.status} ${response.statusText}`);
                }

                const resultado = await response.json();

                if (resultado.status !== 'success') {
                    throw new Error(resultado.message || 'O script retornou um erro.');
                }

                const dadosOcorrencias = resultado.data;

                // 2. Esconder loading, mostrar dashboard
                loadingMsg.classList.add('hidden');
                dashboardContent.classList.remove('hidden');

                // 3. Iniciar o dashboard com os dados reais
                iniciarDashboard(dadosOcorrencias);

            } catch (error) {
                console.error("Erro ao carregar dados do dashboard:", error);
                loadingMsg.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                errorDetails.textContent = error.message;
            }
        });

        // --- FUNÇÃO PARA INICIAR O DASHBOARD (MAPA, MÉTRICAS, GRÁFICOS) ---
        function iniciarDashboard(dadosOcorrencias) {
            
            // --- 1. Inicializar o Mapa ---
            const centroMapa = [-7.952, -36.205];
            const mapa = L.map('mapa').setView(centroMapa, 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapa);

            // Define ícones personalizados
            const iconePendente = L.divIcon({ className: 'pin-vermelho', html: '<i class="fas fa-map-pin fa-3x"></i>', iconSize: [30, 30], iconAnchor: [15, 30] });
            const iconeEmAndamento = L.divIcon({ className: 'pin-amarelo', html: '<i class="fas fa-map-pin fa-3x"></i>', iconSize: [30, 30], iconAnchor: [15, 30] });
            const iconeResolvido = L.divIcon({ className: 'pin-verde', html: '<i class="fas fa-map-pin fa-3x"></i>', iconSize: [30, 30], iconAnchor: [15, 30] });

            // Adiciona os pinos (marcadores) ao mapa
            dadosOcorrencias.forEach(ocorrencia => {
                let icone;
                // O Status 'Pendente' é o default e pode vir vazio
                if (ocorrencia.status === 'Resolvido') icone = iconeResolvido;
                else if (ocorrencia.status === 'Em Andamento') icone = iconeEmAndamento;
                else icone = iconePendente; // Default é Pendente

                L.marker([ocorrencia.latitude, ocorrencia.longitude], { icon: icone })
                    .addTo(mapa)
                    .bindPopup(`<b>${ocorrencia.tipo}</b><br>Status: ${ocorrencia.status || 'Pendente'}<br><small>${ocorrencia.descricao}</small>`);
            });

            // --- 2. Processar Dados para Métricas e Gráficos ---
            let total = dadosOcorrencias.length;
            let pendentes = 0;
            let resolvidos = 0;
            let emAndamento = 0;
            let tipos = {};

            dadosOcorrencias.forEach(o => {
                const status = o.status || 'Pendente'; // Trata status vazio como Pendente
                if (status === 'Pendente') pendentes++;
                else if (status === 'Em Andamento') emAndamento++;
                else if (status === 'Resolvido') resolvidos++;
                
                tipos[o.tipo] = (tipos[o.tipo] || 0) + 1;
            });

            // Atualiza métricas
            document.getElementById('total-metric').textContent = total;
            document.getElementById('pendente-metric').textContent = pendentes;
            document.getElementById('resolvido-metric').textContent = resolvidos;
            // Remove animação de pulso das métricas
            document.querySelectorAll('.spinner-pulse').forEach(el => el.classList.remove('spinner-pulse'));

            // --- 3. Renderizar Gráficos ---
            
            // Gráfico de Status (Doughnut)
            const ctxStatus = document.getElementById('grafico-status').getContext('2d');
            if (graficoStatus) graficoStatus.destroy(); // Destrói gráfico anterior se existir
            graficoStatus = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Pendente', 'Em Andamento', 'Resolvido'],
                    datasets: [{
                        label: 'Status',
                        data: [pendentes, emAndamento, resolvidos],
                        backgroundColor: [corVermelhaStatus, corAmarelaSCC, corVerdeSCC],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            // Gráfico de Tipos (Bar)
            const ctxTipos = document.getElementById('grafico-tipos').getContext('2d');
            if (graficoTipos) graficoTipos.destroy(); // Destrói gráfico anterior se existir
            graficoTipos = new Chart(ctxTipos, {
                type: 'bar',
                data: {
                    labels: Object.keys(tipos),
                    datasets: [{
                        label: 'Nº de Ocorrências',
                        data: Object.values(tipos),
                        backgroundColor: [ corAzulSCC, corVerdeSCC, corAmarelaSCC, corVermelhaStatus ],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y', // Gráfico de barras horizontal
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    </script>
</body>
</html>


